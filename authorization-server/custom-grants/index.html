<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
            <link rel="icon" type="image/x-icon" href="/themes/thephpleague/thephpleague.github.com/img/favicon.ico" />
                <link rel="apple-touch-icon-precomposed" href="/themes/thephpleague/thephpleague.github.com/img/apple-touch-icon-precomposed.png">
                <title>Authorization server custom grants - OAuth 2.0 Server</title>
                <meta name="description" content="A standards compliant OAuth 2.0 server">
                <link rel="stylesheet" href="/themes/thephpleague/thephpleague.github.com/css/all.css">
    </head>
<body>

<section class="all_packages">
    <a href="http://thephpleague.com/">
        <img src="/themes/thephpleague/thephpleague.github.com/img/loep_logo.png" width="195" height="200" alt="The League of Extraordinary Packages">
    </a>
    <h2>Our Packages:</h2>
    <ul>
    </ul>
</section>

<header>
    <a class="logo" href="/">
                <span class="name">OAuth 2.0 Server</span>
        <span class="tagline">PHP, meet OAuth</span>
    </a>
    <a href="http://thephpleague.com/" class="league">
        Presented by The League of Extraordinary Packages
    </a>
</header>

<input type="checkbox" id="menu">
<label for="menu" onclick>
    <div class="closed">&#9776; Menu</div>
    <div class="open">&#9776; Hide Menu</div>
</label>

<main>
    <menu>
                    <h2>Getting Started</h2>
            <ul>
                                    <li >
                        <a href="/">Introduction</a>
                    </li>
                                    <li >
                        <a href="/terminology/">Terminology</a>
                    </li>
                                    <li >
                        <a href="/installation/">Installation</a>
                    </li>
                                    <li >
                        <a href="/implementing-storage-interfaces/">Implementing storage interfaces</a>
                    </li>
                            </ul>
                    <h2>Authorization Server</h2>
            <ul>
                                    <li >
                        <a href="/authorization-server/which-grant/">Which grant?</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/auth-code-grant/">Authorization Code Grant</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/client-credentials-grant/">Client Credentials Grant</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/resource-owner-password-credentials-grant/">Password Grant</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/refresh-token-grant/">Refresh Token Grant</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/customisation/">Server Customisation</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/events/">Events</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/custom-token-identifier-generator/">Custom token identifier generator</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/custom-token-types/">Custom token types</a>
                    </li>
                                    <li >
                        <a href="/authorization-server/custom-grants/">Custom grants</a>
                    </li>
                            </ul>
                    <h2>Resource Server</h2>
            <ul>
                                    <li >
                        <a href="/resource-server/securing-your-api/">Securing your API</a>
                    </li>
                            </ul>
            </menu>
    <article>
        <h1>Authorization server custom grants</h1>

<p>Creating your own grant is simple, just need to write a class that implements <code>League\OAuth2\Server\Grant\GrantTypeInterface</code> and extends <code>League\OAuth2\Server\Grant\AbstractGrant</code>.</p>

<p>Once you've written it you can enable it like so:</p>

<pre><code class="language-php">$server-&gt;addGrantType(new MyGrantType($server));
</code></pre>

<p>Before creating your own grant you should check out the existing grants to see best practise - <a href="https://github.com/thephpleague/oauth2-server/tree/master/src/Grant">https://github.com/thephpleague/oauth2-server/tree/master/src/Grant</a>.</p>

<hr />

<h2>The following properties need to be set:</h2>

<h3><code>protected $identifier</code></h3>

<p>This property is used to identify the grant. When a client requests an access token it will set a <code>grant_type</code> key in the request - when the value of <code>grant_type</code> matches the identifier it will use this grant.</p>

<h2>The following methods need to be implemented:</h2>

<h3><code>public completeFlow()</code></h3>

<p>This method is called by the Authorization server class once it has asserted that the grant type being used by the client is your custom grant.</p>

<p>You should validate all of the data required to complete the flow, remember it is POSTed to the server. You can check values have been set in the request and do any other custom logic like so:</p>

<pre><code class="language-php">$property = $this-&gt;server-&gt;getRequest()-&gt;request-&gt;get('my_property', null);
if (is_null($property)) {
    throw new Exception\InvalidRequestException('my_property');
} else {
    // custom validation here
}
</code></pre>

<p>You can validate the client like so (remember to set the <code>$clientId</code> and <code>$cleintSecret</code> variables by capturing the relevant data from the request as above):</p>

<pre><code class="language-php">$client = $this-&gt;server-&gt;getStorage('client')-&gt;get(
    $clientId,
    $clientSecret,
    null,
    $this-&gt;getIdentifier()
);

if (($client instanceof ClientEntity) === false) {
    throw new Exception\InvalidClientException();
}
</code></pre>

<p>Scopes can be validated like so:</p>

<pre><code class="language-php">$scopeParam = $this-&gt;server-&gt;getRequest()-&gt;request-&gt;get('scope', '');
$scopes = $this-&gt;validateScopes($scopeParam);
</code></pre>

<p>Finally you should create a new session, associate an access token and scopes and then return the access token:</p>

<pre><code class="language-php">// Create a new session
$session = new SessionEntity($this-&gt;server);
$session-&gt;setOwner('client', $client-&gt;getId());
$session-&gt;associateClient($client);

// Generate an access token
$accessToken = new AccessTokenEntity($this-&gt;server);
$accessToken-&gt;setId(SecureKey::generate());
$accessToken-&gt;setExpireTime($this-&gt;server-&gt;getAccessTokenTTL() + time());

// Associate scopes with the session and access token
foreach ($scopes as $scope) {
    $accessToken-&gt;associateScope($scope);
    $session-&gt;associateScope($scope);
}

// Save everything
$session-&gt;save($this-&gt;server-&gt;getStorage('session'));
$accessToken-&gt;setSession($session);
$accessToken-&gt;save($this-&gt;server-&gt;getStorage('access_token'));

$this-&gt;server-&gt;getTokenType()-&gt;set('access_token', $accessToken-&gt;getId());
$this-&gt;server-&gt;getTokenType()-&gt;set('expires_in', $this-&gt;server-&gt;getAccessTokenTTL());

// Return the access token
return $this-&gt;server-&gt;getTokenType()-&gt;generateResponse();
</code></pre>
    </article>
</main>

<footer>
    <span>&copy; Copyright The League of Extraordinary Packages.</span>
    <span>Site design by <a href="http://reinink.ca">Jonathan Reinink</a>.</span>
    <span>Powered by <a href="https://sculpin.io">Sculpin</a>.</span>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="/themes/thephpleague/thephpleague.github.com/js/scripts.js"></script>
<script src="/themes/thephpleague/thephpleague.github.com/js/prism.js"></script>

    <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-46050814-5');ga('send','pageview');
    </script>

</body>
</html>